{% extends "base.html" %} {% load static %} {% block link %}
<link rel="stylesheet" type="text/css" href="{% static 'css/text_annotation.css' %}" />
{% endblock %}

<!-- Content -->
{% block content %}
<main class="container-fluid p-0" id="text-app">
	{% if not exists %}
	<div class="alert alert-warning my-4 w-75 mx-auto d-flex gap-3 align-items-center" role="alert">
		<svg
			class="bi flex-shrink-0"
			xmlns="http://www.w3.org/2000/svg"
			height="1.6rem"
			fill="none"
			stroke="currentColor"
			viewBox="0 0 24 24"
		>
			<path
				stroke-linecap="round"
				stroke-width="1.5"
				d="m14.5 9.5-5 5m0-5 5 5M22 12c0 4.71 0 7.07-1.46 8.54C19.07 22 16.7 22 12 22c-4.71 0-7.07 0-8.54-1.46C2 19.07 2 16.7 2 12c0-4.71 0-7.07 1.46-8.54C4.93 2 7.3 2 12 2c4.71 0 7.07 0 8.54 1.46.97.98 1.3 2.35 1.4 4.54"
			/>
		</svg>

		<p class="m-0">Текст не найден</p>
	</div>
	{% else %}
	<!-- Toolbar for text -->

	<div class="bg-white shadow-sm p-3 sticky-top mt-0 toolbar">
		<div class="btn-group col-auto flex-wrap" role="group">
			<button
				type="button"
				class="btn btn-outline-primary dropdown col-auto shadow-none dropdown-toggle rounded-start rounded-0"
				data-bs-toggle="dropdown"
				aria-expanded="false"
			>
				Вид
			</button>
			<ul class="dropdown-menu">
				<li><h6 class="dropdown-header">Язык разметки</h6></li>
				<li>
					<div class="dropdown-item-text">
						<select id="lang-select" class="form-control" v-model="lang">
							<option id="foreign-option" value="foreign">{{lang_name}}</option>
							<option id="russian-option" value="rus">Русский</option>
						</select>
					</div>
				</li>
				<li><h6 class="dropdown-header">Компактный вид</h6></li>
				<li>
					<div class="dropdown-item-text">
						<div class="form-check form-switch">
							<input class="form-check-input shadow-none" type="checkbox" @change="toggleCompact()" />
						</div>
					</div>
				</li>
				<li><h6 class="dropdown-header">Части речи</h6></li>
				<li>
					<div class="dropdown-item-text">
						<div class="form-check form-switch">
							<input class="form-check-input shadow-none" type="checkbox" @change="togglePos()" />
						</div>
					</div>
				</li>
				<li><h6 class="dropdown-header">Ошибки</h6></li>
				<li>
					<div class="dropdown-item-text">
						<div class="form-check form-switch">
							<input
								class="form-check-input shadow-none"
								type="checkbox"
								checked
								@change="toggleErrors()"
							/>
						</div>
					</div>
				</li>
			</ul>

			<button
				type="button"
				class="btn btn-outline-primary dropdown col-auto shadow-none dropdown-toggle rounded-0"
				data-bs-toggle="dropdown"
				aria-expanded="false"
			>
				Текст
			</button>
			<ul class="dropdown-menu">
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Курс создания: </span>
						{{text_info.course}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Дата создания: </span>
						{{text_info.create_date}}
					</div>
				</li>
				<li><hr class="dropdown-divider" /></li>
				<li>
					<div class="dropdown-item-text text-center">
						<a href="{% url 'show_raw' text_id=text_id %}" class="link-primary btn shadow-none"
							>Исходный текст
						</a>
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<button
							class="link-primary btn shadow-none"
							onclick="process_part_of_speech(event, '{{language}}', '{{text_type}}', '{{text_id}}')"
						>
							Обновить частеречную разметку
						</button>
					</div>
				</li>
				{%if superuser%}
				<li>
					<div class="dropdown-item-text">
						<form
							method="post"
							novalidate
							action="{% url 'delete_text' %}"
							class="d-flex justify-content-center"
						>
							<input type="hidden" name="text_id" value="{{ text_id }}" />
							<button
								type="submit"
								class="link-danger btn shadow-none"
								onclick="return confirm('Удалить текст?')"
							>
								Удалить текст
							</button>
						</form>
					</div>
				</li>
				{%endif%}
			</ul>

			<button
				type="button"
				class="btn btn-outline-primary dropdown col-auto shadow-none dropdown-toggle rounded-0"
				data-bs-toggle="dropdown"
				aria-expanded="false"
			>
				Автор
			</button>
			<ul class="dropdown-menu">
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Имя: </span>
						{{text_info.author_name}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Группа: </span>
						{{text_info.group_number}}
					</div>
				</li>
				{%if text_owner or teacher and user.language_id == language.id_language %}
				<li><hr class="dropdown-divider" /></li>
				<li>
					<div class="dropdown-item-text text-center">
						<a href="{%url 'author_edit' text_id=text_id %}" class="link-primary btn shadow-none"
							>Изменить</a
						>
					</div>
				</li>
				{%endif%}
			</ul>

			<button
				type="button"
				class="btn btn-outline-primary dropdown col-auto shadow-none dropdown-toggle rounded-0"
				data-bs-toggle="dropdown"
				aria-expanded="false"
			>
				Проверка
			</button>
			<ul class="dropdown-menu">
				<li><h6 class="dropdown-header text-primary">Оценка работы</h6></li>
				{%if text_info.assessment %}
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Оценка: </span>
						{{text_info.assessment}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Полнота: </span>
						{{text_info.completeness}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Структура: </span>
						{{text_info.structure}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Связность: </span>
						{{text_info.coherence}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Проверяющий: </span>
						{{text_info.teacher_name}}
					</div>
				</li>
				{%else%}
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Оценка: </span>
						Не указано
					</div>
				</li>
				{%endif%}

				<li><h6 class="dropdown-header text-primary">Частеречная разметка</h6></li>
				{%if text_info.pos_check%}
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Статус: </span>
						<span class="text-success">Проверено</span>
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Проверяющий: </span>
						{{text_info.pos_check_name}}
					</div>
				</li>
				{%else%}
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Статус: </span>
						<span class="text-danger">Не проверено</span>
					</div>
				</li>
				{%endif%}

				<li><h6 class="dropdown-header text-primary">Разметка ошибок</h6></li>
				{%if text_info.error_check%}
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Статус: </span>
						<span class="text-success">Проверено</span>
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Проверяющий: </span>
						{{text_info.error_check_name}}
					</div>
				</li>
				{%else%}
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Статус: </span>
						<span class="text-danger">Не проверено</span>
					</div>
				</li>
				{%endif%} {%if ann_right %}
				<li><hr class="dropdown-divider" /></li>
				<li>
					<div class="dropdown-item-text text-center">
						<a href="{% url 'assessment_edit' text_id=text_id %}" class="link-primary btn shadow-none"
							>Изменить</a
						>
					</div>
				</li>
				{%endif%}
			</ul>

			{% if auto_degree%}
			<button
				type="button"
				class="btn btn-outline-primary dropdown col-auto shadow-none dropdown-toggle rounded-0"
				data-bs-toggle="dropdown"
				aria-expanded="false"
			>
				Автооценка
			</button>
			<ul class="dropdown-menu">
				<li><h6 class="dropdown-header text-primary">Грамматика</h6></li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Степень 1: </span>
						{{auto_grammatik.0}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Степень 2: </span>
						{{auto_grammatik.1}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Степень 3: </span>
						{{auto_grammatik.2}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Оценка: </span>
						{{auto_grammatik.3}}
					</div>
				</li>

				<li><h6 class="dropdown-header text-primary">Лексика</h6></li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Степень 1: </span>
						{{auto_lexik.0}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Степень 2: </span>
						{{auto_lexik.1}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Степень 3: </span>
						{{auto_lexik.2}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Оценка: </span>
						{{auto_lexik.3}}
					</div>
				</li>

				<li><h6 class="dropdown-header text-primary">Орфография и пунктуация</h6></li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Степень 1: </span>
						{{auto_orth.0}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Степень 2: </span>
						{{auto_orth.1}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Степень 3: </span>
						{{auto_orth.2}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Оценка: </span>
						{{auto_orth.3}}
					</div>
				</li>

				<li><h6 class="dropdown-header text-primary">Подсчёт ошибок</h6></li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Дискурс: </span>
						{{count_dis}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Пропуски: </span>
						{{count_skip}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Лишние элементы: </span>
						{{count_extra}}
					</div>
				</li>
			</ul>

			{%endif%}

			<button
				type="button"
				class="btn btn-outline-primary dropdown col-auto shadow-none dropdown-toggle rounded-end"
				data-bs-toggle="dropdown"
				aria-expanded="false"
			>
				Метаданные
			</button>
			<ul class="dropdown-menu">
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Эмоционально-физиологическое состояние: </span>
						{{text_info.emotional}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Место написания: </span>
						{{text_info.write_place}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Год изучения языка: </span>
						{{text_info.education_level}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Самооценивание: </span>
						{{text_info.self_rating}}
					</div>
				</li>
				<li>
					<div class="dropdown-item-text">
						<span class="text-secondary">Оценка задания студентом: </span>
						{{text_info.student_assessment}}
					</div>
				</li>
				{%if text_owner%}
				<li><hr class="dropdown-divider" /></li>
				<li>
					<div class="dropdown-item-text text-center">
						<a href="{%url 'meta_edit' text_id=text_id%}" class="link-primary btn shadow-none">Изменить</a>
					</div>
				</li>
				{%endif%}
			</ul>
		</div>
	</div>
	<div class="bg-white p-3 shadow-sm">
		<h3 class="text-primary">{{lang_name}} / {{text_info.text_type}} / {{text_info.text_name}}</h3>
		<h5 class="text-secondary mb-2">{{text_info.author_name}}</h5>
	</div>
	<!-- Text area -->
	<div>
		<h3 v-if="!text_data" class="text-secondary text-center my-5">Загрузка текста...</h3>
		<div v-else v-cloak>
			<text-area
				:text_data="text_data"
				@refresh-text="refresh"
				@select-token="selectToken"
				@unselect-tokens="unselectTokens"
			/>
		</div>
	</div>
	{% endif %}
</main>
{% endblock content %}

<!-- Scripts -->
{% block script %}
<script type="text/javascript">
				// Vue
				const FooterToolbar = {
					delimiters: ['[[', ']]'],
					inject: ['selectedTokens', 'selectedEmptyTokens', 'ann_right'],
					emits: ['unselect-tokens', 'refresh-text'],
					computed: {
						selectedTokenCount() {
							return this.selectedTokens.size;
						}
					},
					methods: {
						unselectTokens() {
							this.$emit('unselect-tokens');
						},
						async deleteTokens() {
							for (let token_id of this.selectedEmptyTokens) {
								await delete_token(token_id);
							}

							this.$emit('refresh-text');
						},
						addAnnotation() {
							create_annotation_selection(this.selectedTokens);
						},
						isActive() {
							return this.selectedTokenCount > 0;
						}
					},
					template: `
						<div v-if='ann_right' class='bottom-toolbar fixed-bottom bg-white p-4 d-flex gap-2 shadow-lg align-items-center' :class='{"show": isActive()}'>
							<button class='btn btn-primary shadow-none' @click='addAnnotation'>Добавить аннотацию</button>
							<button class='btn btn-danger shadow-none' @click='deleteTokens' :disabled='this.selectedEmptyTokens.size == 0'>Удалить выбранные пустые токены</button>
							<button class='btn btn-secondary shadow-none' @click='unselectTokens'>Снять выделение</button>
							<span class='text-secondary ms-auto d-none d-md-block'>Выбрано токенов: [[this.selectedTokenCount]]</span>
						</div>
					`
				}

				const Modal = {
					delimiters: ['[[', ']]'],
					emits: ['refresh-text'],
					mounted() {
						const modal = this.$refs.modal;
						let posX, posY, mouseX, mouseY;
						const handle = this.$refs.handle;
						modal.addEventListener('click', (e) => {
							e.stopPropagation();
						})

						handle.addEventListener('mousedown', function (event) {
								posX = modal.offsetLeft;
								posY = modal.offsetTop;
								mouseX = event.clientX;
								mouseY = event.clientY;

								this.addEventListener('mousemove', moveElement, false);
								window.addEventListener('mouseup', function () {
										handle.removeEventListener('mousemove', moveElement, false);
								}, false);
						}, false);

						function moveElement(event) {
								modal.style.left = Math.max(posX + event.clientX - mouseX, 0) + 'px';
								modal.style.top =  Math.max(posY + event.clientY - mouseY, 64) + 'px';
						}
					},
					methods: {
						close() {
							closeModal();
						},
						async saveAnnotation() {
							const resp = await send_annotation_info();
							this.$emit('refresh-text');
							closeModal();
						},
						async deleteAnnotation() {
							await delete_annotation_info();
							this.$emit('refresh-text');
							closeModal();
						}
					},
					template: `<div ref="modal" class="modal bg-white shadow-lg ">
											<div ref="handle" class='handle bg-primary text-white py-2 px-4	d-flex justify-content-between align-items-center w-100'>
												<h4>Аннотация</h4>
												<button class='btn text-white' @click='close()'>
													<svg xmlns="http://www.w3.org/2000/svg" class='bi' height="1.6em" fill="none" viewBox="0 0 24 24" stroke="currentColor">
														<path stroke-linecap="round" stroke-width="1.5" d="m14.5 9.5-5 5m0-5 5 5M7 3.338A9.954 9.954 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5"/>
													</svg>
												</button>
											</div>

											<div id = "annotation-create-form-content" class="p-3">
												<div id = "tag-type-create-form-area" >
													<div id ="tag-type-create-form-area-name" class='text-secondary'>Выберите тег:</div>
														<div id = "tag-type-create-form-area-content" class='d-flex flex-column gap-2'>
															<div id="tag-type-create-form-classification" content-tag-id="0" class='my-2 border rounded px-2 align-self-center' ></div>
															<div id = "tag-type-selected-tag-area" class='d-flex flex-column gap-1'><span class='text-secondary'>Выбранный тег: </span><div id = "tag-type-selected-tag" class='px-2 py-1 rounded'></div></div>
															<form id = "annotation-create-form-data" method = "none" onsubmit ="false;" disabled class='d-flex flex-column gap-2 text-secondary'>
																	{{annotation_form.query_type}}
																	{{annotation_form.classification_tag}}
																	{{annotation_form.tokens}}
																	{{annotation_form.markup_id}}

																	<label for={{annotation_form.reason.id_for_label}} class='d-flex gap-2 align-items-center'>
																		<span class='col-5 col-md-3'>Причина ошибки:</span>
																		{{annotation_form.reason}}
																	</label>
																	<label for={{annotation_form.grade.id_for_label}} class='d-flex gap-2 align-items-center'>
																		<span class='col-5 col-md-3'>Степень грубости:</span>
																		{{annotation_form.grade}}
																	</label>
																	<label for={{annotation_form.correct.id_for_label}} class='d-flex gap-2 align-items-center'>
																		<span class='col-5 col-md-3'>Исправление:</span>
																		{{annotation_form.correct}}
																	</label>
																	<label for={{annotation_form.comment.id_for_label}} class='d-flex gap-2 align-items-center'>
																		<span class='col-5 col-md-3'>Комментарий:</span>
																		{{annotation_form.comment}}
																	</label>

																	<div id="creator-field"><span class='text-secondary'>Создатель аннотации: </span><span id="creator-name"></span></div>
																	<div class = 'd-flex gap-2 my-2 justify-content-evenly'>
																			<button class = "btn btn-primary col-5" id = "form-save-button" type = "button" @click = "saveAnnotation()">Сохранить</button>
																			<button class = "btn btn-danger col-5"  style = "margin-left:10px;" id = "form-delete-button" type = "button" @:click="deleteAnnotation()">Удалить</button>
																	</div>
																</form>
															</div>
														</div>
													</div>
											</div>
											`
				}

				const ModalContainer = {
					delimiters: ['[[', ']]'],
					emits: ['refresh-text'],
					components: {
						Modal
					},
					methods: {
						close() {
							closeModal();
						},
						refresh() {
							this.$emit('refresh-text');
						},
					},
					template: `<div id='modal-container' @click='close'>
							<modal @refresh-text="refresh"  />
						</div>`
				}

				const Annotation = {
					delimiters: ['[[', ']]'],
					inject: ['errors', 'pos', 'compact', 'translate', 'ann_right'],
					emits: ['select-annotation'],
					props: {
						annotation_data: Object,
						markup_data: Object
					},
					computed: {
						style() {
				       return 'color:' + getVisibleColor(this.markup_data.tag_color) +'; background-color: ' + this.markup_data.tag_color;
				     },
						 tooltip_data() {
							if (this.markup_data.markup_type == 1) {
								const markup = this.markup_data;
								return  `<b>${markup.tag_text}` +
												(markup.tag_text_abbrev ? ` (${markup.tag_text_abbrev})</b>` : '</b>') +
												(markup.grade_text ? `<br>Степень грубости: ${markup.grade_text}` : '') +
												(markup.reason_text ? `<br>Причина: ${markup.reason_text}` : '') +
												(markup.correct ? `<br>Исправление: <b>${markup.correct}</b>` : '') +
												(markup.comment ? `<br>Комментарий: ${markup.comment}` : '');
							}
						}
					},

					methods: {
						onHover() {
							this.$emit('select-annotation', this.annotation_data.ann_id, true, this.style);
						},
						onLeave() {
							this.$emit('select-annotation', this.annotation_data.ann_id, false, '');
						},
						handleClick() {
							if (this.ann_right) {
								modify_annotation_selection(this.annotation_data.ann_id, this.markup_data);
							}
						},
						makeTooltip() {
							if ((this.markup_data.markup_type == 1 && this.errors) || (this.markup_data.markup_type == 2 && this.pos)) {
								this.$nextTick(() => {
									new bootstrap.Tooltip(this.$refs.annotation, {html: true})
								});
							}
						}
					},

					updated() {
						this.makeTooltip();
					},
					mounted() {
						this.makeTooltip();
					},

					template:	`
						<button ref="annotation"  v-if='(markup_data.markup_type == 1 && errors) || (markup_data.markup_type == 2 && pos)'
						 class='annotation btn shadow-none text-center px-2 py-1 rounded'
						 data-bs-toggle="tooltip"
						 :style='style'
						 @click='handleClick' @mouseenter='onHover()' @mouseleave='onLeave()'
						 :title='tooltip_data'
						 >
							<div v-if='compact'>[[markup_data.tag_text_abbrev]]</div>
							<div v-else-if='markup_data.markup_type == 1 && translate'>[[markup_data.tag_text_russian]]</div>
							<div v-else>[[markup_data.tag_text]]</div>
						</button>
					`
				}

				const NewTokenButton = {
					delimiters: ['[[', ']]'],
					inject: ['ann_right'],
					props: {
						parent_token_id: Number,
						position: String,
					},
					methods: {
						handleClick: async function() {
							await add_token(this.parent_token_id, this.position);
						  this.$emit('refresh-text');
						}
					},
					emits: ['refresh-text'],
					template: `
						<button @click='handleClick' v-if='ann_right' class='add-token-btn text-primary btn shadow-none px-0 mx-0' title='Добавить пустой токен'>
							<svg xmlns="http://www.w3.org/2000/svg" class='bi' height="1.2em" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				 				<path stroke-linecap="round" stroke-width="1.5" d="M15 12h-3m0 0H9m3 0V9m0 3v3M7 3.338A9.954 9.954 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5"/>
							</svg>
						</button>
					`
				}

				const Token = {
					delimiters: ['[[', ']]'],
					inject: ['ann_right'],
					props: {
				   	token_data: Object,
					},
					components: {
						NewTokenButton,
						Annotation
					},
					emits: ['refresh-text', 'select-annotation', 'select-token'],
					methods: {
						refresh() {
							this.$emit('refresh-text');
						},
						selectAnnotation(annotation_id, select, style) {
							this.$emit('select-annotation', annotation_id, select, style);
						},
						selectToken() {
							if (this.ann_right) {
								this.$emit('select-token', this.token_data.token_id, false);
							}
						},

						selectEmptyToken() {
							if (this.ann_right) {
								this.$emit('select-token', this.token_data.token_id, true);
							}
						}
					},
					template: `
						<new-token-button @refresh-text="refresh" v-if='token_data.order_number === 0' :parent_token_id='token_data.token_id' position="left"/>
						<div class='d-flex flex-column justify-content-end gap-1'>
							<annotation @select-annotation='selectAnnotation' v-for='[markup_id, markup] in token_data.markup' :key=markup_id :annotation_data=markup.annotation_data :markup_data=markup.markup_data />
							<button :id=[[this.token_data.token_id]] @click='selectToken' v-if='token_data.text !== ""' class='token shadow-sm px-2 py-1 rounded-2 btn' :class='{muted: !ann_right}'>[[token_data.text]]</button>
							<button :id=[[this.token_data.token_id]] @click='selectEmptyToken' v-else class='token shadow-sm px-2 py-1 rounded-2 btn' :class='{muted: !ann_right}' >
								<svg xmlns="http://www.w3.org/2000/svg" class='bi' height="1em" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-width="1.5" d="m14.36 4.079.927-.927a3.932 3.932 0 0 1 5.561 5.561l-.927.927m-5.56-5.561s.115 1.97 1.853 3.707C17.952 9.524 19.92 9.64 19.92 9.64m-5.56-5.561L12 6.439m7.921 3.2-5.26 5.262L11.56 18l-.16.161c-.578.577-.867.866-1.185 1.114a6.554 6.554 0 0 1-1.211.749c-.364.173-.751.302-1.526.56l-3.281 1.094m0 0-.802.268a1.06 1.06 0 0 1-1.342-1.342l.268-.802m1.876 1.876-1.876-1.876m0 0 1.094-3.281c.258-.775.387-1.162.56-1.526.205-.43.456-.836.749-1.211.248-.318.537-.607 1.114-1.184L8.5 9.939"/>
								</svg>

							</button>
						</div>
						<new-token-button @refresh-text="refresh" :parent_token_id='token_data.token_id' position="right"/>
					`
				}

				const Sentence = {
					delimiters: ['[[', ']]'],
					components: {
						Token
					},
					props: {
				   sentence_data: Object,
					},
					data() {
						return {
						}
					},
					emits: ['refresh-text', 'select-annotation', 'select-token'],
					methods: {
						refresh() {
							this.$emit('refresh-text');
						},
						selectAnnotation(annotation_id, select, style) {
							this.$emit('select-annotation', annotation_id, select, style);
						},
						selectToken(token_id, empty) {
							this.$emit('select-token', token_id, empty);
						}
					},
					template: `
					<div class='d-flex align-items-end gap-1'>
						<token @refresh-text="refresh" @select-annotation='selectAnnotation' @select-token='selectToken' v-for='[token_id, token_data] in sentence_data' :key='token_id' :token_data='token_data' />
					</div>`
				}

				const TextArea = {
					delimiters: ['[[', ']]'],
					props: {
				   text_data: Object
					},
					components: {
						Sentence,
						ModalContainer,
						FooterToolbar
					},
					data() {
						return {
							tokensByMarkupId: Vue.computed(() => buildTokensByMarkupId(this.text_data))
						}
					},
					emits: ['refresh-text', 'select-token', 'unselect-tokens'],
					methods: {
						refresh() {
							this.$emit('refresh-text');
						},
						selectToken(token_id, empty) {
							this.$emit('select-token', token_id, empty);
						},
						unselectTokens() {
							this.$emit('unselect-tokens');
						},
						selectAnnotation(annotation_id, select, style) {
							for (let token_id of this.tokensByMarkupId.get(annotation_id)) {
								tokenElement = document.getElementById(token_id);
								if (select) {
									tokenElement.style.cssText = style;
								}
								else {
									tokenElement.style.cssText = '';
								}
							}
						}
					},
					template: `
					<modal-container @refresh-text="refresh" />
						<div class='table-responsive my-4 text-area'>
							<table class='table text-nowrap'>
								<tr v-for='(sentence, index) in text_data.sentences' :key='index'>
									<td class='pe-2 ps-4 text-secondary text-center col-auto align-bottom py-3'>[[index + 1]]</td>
									<td class='col-12'><sentence @select-token='selectToken' @refresh-text="refresh" @select-annotation='selectAnnotation' :sentence_data=sentence /></td>
								</tr>
							</table>
						</div>
						<footer-toolbar @unselect-tokens='unselectTokens'  @refresh-text="refresh" />
					`
				}

				Vue.createApp({
					delimiters: ['[[', ']]'],
					components: {
						TextArea
					},

					data() {
						return {
							text_data: null,
							text_id: {{text_id}},
							compact: false,
							pos: false,
							errors: true,
							lang: 'foreign',
							selected_tokens: new Set(),
							selected_empty_tokens: new Set(),
						}
					},
					provide() {
						return {
							ann_right: '{{ann_right}}' === 'True',
							errors: Vue.computed(() => this.errors),
							pos: Vue.computed(() => this.pos),
							compact: Vue.computed(() => this.compact),
							translate: Vue.computed(() => this.lang === 'rus'),
							selectedTokens: Vue.computed(() => this.selected_tokens),
							selectedEmptyTokens: Vue.computed(() => this.selected_empty_tokens)
						}
					},
					watch: {
						lang(newLang, oldLang) {
							get_classification({{text_id}}).then(response => { build_classification(response, (newLang === 'rus')); })
						}
					},
					methods: {
						async fetchTextData() {
				   		return await get_text_data(this.text_id).then(raw_data => format_text_data(raw_data));
				   	},
						async refresh() {
							const text_data = await this.fetchTextData();
							this.text_data = text_data;
							text_response = text_data;
							this.unselectTokens();
							get_classification({{text_id}}).then(response => {
							build_classification(response, this.translate);
						});
						},

						selectToken(token_id, empty) {
							if (this.selected_tokens.has(token_id)) {
								this.selected_tokens.delete(token_id);
								document.getElementById(token_id).classList.remove('active');
								if (empty) {
									this.selected_empty_tokens.delete(token_id);
								}
							}
							else {
								this.selected_tokens.add(token_id);
								document.getElementById(token_id).classList.add('active');
								if (empty) {
									this.selected_empty_tokens.add(token_id);
								}
							}
						},



						unselectTokens() {
							for (let token_id of this.selected_tokens) {
								document.getElementById(token_id).classList.remove('active');
							}
							this.selected_tokens.clear();
							this.selected_empty_tokens.clear();
						},

						toggleCompact() {
							this.compact = !this.compact;
						},
						togglePos() {
							this.pos = !this.pos;
						},
						toggleErrors() {
							this.errors = !this.errors;
						},
					},

					mounted() {
				   	this.refresh();
				 	},

				}).mount('#text-app');

				// Modal
				function closeModal() {
					document.getElementById('modal-container').classList.remove('open');
					document.getElementById("annotation-create-form-data").reset();
					document.getElementById("creator-name").innerText = "";
				}
				function openModal() {
					document.getElementById('modal-container').classList.add('open');
				}

				let selected_tag = 0;

				function modify_annotation_selection(markup_id, markup_data) {

					document.getElementById("selected-markup-id").value = markup_id;
					const using_tag_id = markup_data.tag_id;
					selected_tag = using_tag_id;

					document.getElementById("selected-classif-tag").value = using_tag_id;
					const reason_options = document.getElementById('selected_reason').getElementsByTagName("option");
					for(let i = 0; i<reason_options.length;i++) {
							if(reason_options[i].value == markup_data.reason_id) {
									reason_options[i].parentNode.selectedIndex = i;
									break;
							}
					}
					const grade_options = document.getElementById('selected_grade').getElementsByTagName("option")
					for(let i = 0; i<grade_options.length;i++){
							if(grade_options[i].value == markup_data.grade_id){
									grade_options[i].parentNode.selectedIndex = i;
									break;
							}
					}
					document.getElementById("correct-text").value = markup_data.correct;
					document.getElementById("comment-text").value = markup_data.comment;
					document.getElementById("creator-name").innerText = `${markup_data.user_name} ${markup_data.user_last_name}`;
					document.getElementById("form-delete-button").style.display = "block";
					document.getElementById("query-type-field").value = 2;
					const display_tag_name = document.getElementById("tag-type-selected-tag");
					display_tag_name.innerText = markup_data.tag_text;
					display_tag_name.style.display = "block";
					display_tag_name.style.backgroundColor = markup_data.tag_color;
					display_tag_name.style.color = getVisibleColor(markup_data.tag_color);

					reset_errors_fields(markup_data.markup_type == 2);
					openModal();
			}

				function create_annotation_selection(selectedTokens) {
					document.getElementById("query-type-field").value = 1
					document.getElementById("selected-tokens").value = `[${Array.from(selectedTokens).toString()}]`
					document.getElementById("correct-text").value = ''
					document.getElementById("comment-text").value = ''
					document.getElementById("creator-name").innerText = '{{user.name}} {{user.last_name}}'
					openModal();
				}

				function get_classification(text_id) {
		    return axios({
		        url: "{%url 'get_classification' %}",
		        method: 'POST',
		        data: {'text_id': text_id },
		        headers: {"X-CSRFToken": "{{csrf_token}}"},
		        }).catch((error) => {
		            console.log(error.message);
		        });
			}

				function build_classification(response, translate){
					const tags_field = document.getElementById("tag-type-create-form-classification")
					while (tags_field.firstChild) {
							tags_field.removeChild(tags_field.firstChild);
					}

					const tags = response.data.tags
					for(let i = 0; i < tags.length; i++){
							const tag =  document.createElement('div')
							tag.setAttribute('class','classification-area')
							tag.setAttribute('area-tag-id',`${tags[i].tag_id}`)
							var info = document.createElement('div')
							info.setAttribute('class','classifiation-tag-info')

							var selector = document.createElement('div')
							selector.setAttribute('class','classification-tag-name')
							selector.setAttribute('name-tag-id',`${tags[i].tag_id}`)
							selector.setAttribute('name-tag-type',`${tags[i].tag_type}`)
							selector.setAttribute('name-tag-color',`${tags[i].tag_color}`)
							selector.setAttribute('style',`background-color: ${tags[i].tag_color}; color: ${getVisibleColor(tags[i].tag_color)};`)
							if (!String(tags[i].tag_text_abbrev).includes('#IGNORE#')){
									selector.addEventListener('click', select_classification_selector);
							}
							const parent = document.querySelector(`[content-tag-id = "${tags[i].parent_id}"]`)
							if(!translate){
									selector.innerText = tags[i].tag_text
							}
							else{
									selector.innerText = tags[i].tag_text_russian
							}
							if(tags[i].isspoiler){
									const spoiler = document.createElement('div')
									spoiler.setAttribute('class','classification-tag-spoiler me-2')
									spoiler.setAttribute('spoiler-tag-id',`${tags[i].tag_id}`)
									spoiler.setAttribute('spoiler-condition','0')
									spoiler.addEventListener('click', select_classification_spoiler)
									spoiler.innerHTML = `<svg class='bi text-secondary' xmlns="http://www.w3.org/2000/svg" stroke='currentColor' height="1.6em" fill="none" viewBox="0 0 24 24">
																				<path  stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m10.5 9 3 3-3 3"/>
																				<path  stroke-linecap="round" stroke-width="1.5" d="M7 3.338A9.954 9.954 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5"/>
																			</svg>`
									const content = document.createElement('div')
									content.setAttribute('class','classification-tag-content')
									content.setAttribute('content-tag-id',`${tags[i].tag_id}`)

									info.appendChild(spoiler)
									info.appendChild(selector)
									tag.appendChild(info)
									tag.appendChild(content)
									parent.appendChild(tag)
							}
							else{
									info.appendChild(selector)
									tag.appendChild(info)
									parent.appendChild(tag)
							}
					}
				}

				function select_classification_spoiler(event){
						var element = event.currentTarget
						if(element.getAttribute('spoiler-condition') == 0){
								element.innerHTML = `<svg class='bi text-secondary' xmlns="http://www.w3.org/2000/svg" stroke='currentColor' height="1.6em" fill="none" viewBox="0 0 24 24">
																			<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m15 10.5-3 3-3-3"/>
																			<path stroke-linecap="round" stroke-width="1.5" d="M7 3.338A9.954 9.954 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5"/>
																		</svg>
	`
								element.setAttribute('spoiler-condition','1')
								const element_id = element.getAttribute('spoiler-tag-id')
								const content = document.querySelector(`[content-tag-id = "${element_id}"]`)
								content.style.display = "block"
					    }
						else{
								element.innerHTML = `<svg class='bi text-secondary' xmlns="http://www.w3.org/2000/svg" stroke='currentColor' height="1.6em" fill="none" viewBox="0 0 24 24">
																				<path  stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m10.5 9 3 3-3 3"/>
																				<path  stroke-linecap="round" stroke-width="1.5" d="M7 3.338A9.954 9.954 0 0 1 12 2c5.523 0 10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12c0-1.821.487-3.53 1.338-5"/>
																			</svg>`
								element.setAttribute('spoiler-condition','0')
								const element_id = element.getAttribute('spoiler-tag-id')
								const content = document.querySelector(`[content-tag-id = "${element_id}"]`)
								content.style.display = "none"
						}
				}

				function select_classification_selector(event){
		    if(selected_tag > 0){
		        const old_tag = document.querySelector(`[name-tag-id = "${selected_tag}"]`)
		    }
		    else{
		        document.getElementById("annotation-create-form-data").style.display = "block"
		    }
		    selected_tag = event.currentTarget.getAttribute("name-tag-id")
		    document.getElementById("selected-classif-tag").value = selected_tag
		    const display_tag_name = document.getElementById("tag-type-selected-tag")
		    display_tag_name.innerText = event.currentTarget.innerText
		    display_tag_name.style.display = "block"
		    display_tag_name.style.backgroundColor = event.currentTarget.getAttribute("name-tag-color")
				display_tag_name.style.color = getVisibleColor(event.currentTarget.getAttribute("name-tag-color"))

		    const change_tag_type = event.currentTarget.getAttribute('name-tag-type')
		    reset_errors_fields(change_tag_type == 2);
		}

				function reset_errors_fields(hide_fields){
					if(hide_fields){
							const err_fields = document.getElementsByClassName("only-errors")
							for(let i=0; i<err_fields.length;i++){
									err_fields[i].parentNode.style.display = "none"
									if(err_fields[i].tagName=="SELECT"){
											err_fields[i].selectedIndex = 0;
									}
									else{
											err_fields[i].value = ""
									}
							}
						}
						else {
							const err_fields = document.getElementsByClassName("only-errors")
							for(let i=0; i<err_fields.length;i++){
									err_fields[i].parentNode.style.display = "block"
							}
						}
					}

			async function send_annotation_info() {
		   const reason_sel = document.getElementById("selected_reason");
		   const grade_sel = document.getElementById("selected_grade");
			 const data = {   'user_id':{{user_id}},
		           'query_type': document.getElementById("query-type-field").value,
		           'classification_tag': document.getElementById("selected-classif-tag").value,
		           'tokens': document.getElementById("selected-tokens").value,
		           'markup_id': document.getElementById("selected-markup-id").value,
		           'reason': reason_sel.options[reason_sel.selectedIndex].value,
		           'grade': grade_sel.options[grade_sel.selectedIndex].value,
		           'correct':document.getElementById("correct-text").value,
		           'comment': document.getElementById('comment-text').value }

		   return axios(
				{
		       url: "{%url 'annotation_edit' %}",
		       method: 'POST',
		       data: data,
		       headers: {"X-CSRFToken": "{{csrf_token}}"},
		       }).catch((error) => {
		           console.log(error.message);
		       });
			}

			function delete_annotation_info(){
		   return axios({
		       url: "{%url 'annotation_edit' %}",
		       method: 'POST',
		       data:
		       {   'query_type': '3',
		           'markup_id': document.getElementById("selected-markup-id").value,
		       },
		       headers: {"X-CSRFToken": "{{csrf_token}}"},
		       }).catch((error) => {
						console.log(error.message);
		       });
				}

				async function delete_token(token_id) {
					return axios(
						{
							url: "{%url 'delete_token' %}",
							method: 'POST',
							data: { 'token_id' : Number(token_id) },
							headers: {"X-CSRFToken": "{{csrf_token}}"},
							}).catch((error) => {
									console.log(error.message);
							});
				}

				// Text logic
				async function get_text_data(text_id) {
					const response = await axios({
						url: "{%url 'get_text' %}",
						method: 'POST',
						data: { text_id: text_id },
						headers: { 'X-CSRFToken': '{{csrf_token}}' },
					})
					.catch((error) => {
							console.log(error.message);
					});
					return response.data;
				}

				class TextElement {
					constructor (id, text, order_number) {
						this.token_id = id;
						this.markup = new Map();
						this.text = text;
						this.order_number = order_number;
					}

					add_markup_data(markup_id, markup_data) {
						if (this.markup.has(markup_id)) {
							this.markup.get(markup_id).markup_data = markup_data;
						}
						else {
							this.markup.set(markup_id, {
								annotation_data: null,
								markup_data: markup_data
							});
						}
					}

					add_annotation_data(markup_id, annotation_data) {
						if (this.markup.has(markup_id)) {
							this.markup.get(markup_id).annotation_data = annotation_data;
						}
						else {
							this.markup.set(markup_id, {
								annotation_data: annotation_data,
								markup_data: null
							});
						}
					}
				}

				async function format_text_data(raw_text_data) {
					let sentences = [];

					for (let sentence of raw_text_data.sentences) {
						let sentence_elements = new Map();

						for (let token of sentence.tokens) {
							let element = new TextElement(token.token_id, token.text, token.order_number);
							if (token.markups_ids.trim() !== '') {
								for (let markup_id of token.markups_ids.trim().split(' ').map(Number)) {
									let markup_data = raw_text_data.markup_info[markup_id];
									element.add_markup_data(markup_id, markup_data);
								}
							}

							sentence_elements.set(token.token_id, element);
						}

						for (let annotation_array of sentence.annotations) {
							for (let annotation of annotation_array) {
								if (annotation.isann) {
									sentence_elements.get(annotation.token_id).add_annotation_data(annotation.ann_id, annotation);
								}
							}
						}
						sentences.push(sentence_elements);
					}

					return {sentences};
				}

				function buildTokensByMarkupId(text_data) {
					let tokensByMarkupId = new Map();

					for (let sentence of text_data.sentences) {
						for (let token of sentence.values()) {
							for (let markup_id of token.markup.keys()) {
								if (!tokensByMarkupId.has(markup_id)) {
									tokensByMarkupId.set(markup_id, [token.token_id]);
								}
								else {
									tokensByMarkupId.get(markup_id).push(token.token_id);
								}
							}
						}
					}

					return tokensByMarkupId;
				}

				async function add_token(parent_token_id, position){
					return await axios({
							url:"{% url 'add_empty_token' %}",
							method: 'POST',
							data:{'parent_token': parent_token_id, 'append_position':position},
							headers: {"X-CSRFToken": "{{csrf_token}}"}
					}).catch((error) => {
						console.log(error.message);
					});
				 }

				 function process_part_of_speech(eventData, language, text_type, text_id) {
					eventData.preventDefault();

					if (!window.confirm('Вы действительно желаете обновить частеречную разметку? Старая разметка будет удалена')) {
						return;
					}

					let process_url = "{% url 'part_of_speech' %}";
					fetch(process_url, {
						method: 'POST',
						body: JSON.stringify({ language, text_type, text_id }),
					}).then(
						(response) => {
							if (response.ok) {
								window.alert('Частеречная разметка обновлена!');
								document.getElementById('update_part_of_speech_btn').style.display = 'block';
								return;
							} else {
								window.alert('Ошибка разметки текста: ' + response.statusText);
							}
						},
						(networkError) => {
							window.alert('Ошибка разметки текста: ' + networkError.message);
						}
					);
				}

				// Auxiliary methods
				function brightnessByColor (hexcolor) {
					const color = "" + hexcolor
					var m = color.substr(1).match(color.length == 7 ? /(\S{2})/g : /(\S{1})/g);
					if (m) {
						var r = parseInt(m[0], 16), g = parseInt(m[1], 16), b = parseInt(m[2], 16);
					}

					if (typeof r != "undefined") return ((r*299)+(g*587)+(b*114)) / 1000;
				}

				function getVisibleColor(color) {
					const brightness = brightnessByColor(color);
					if (brightness > 255 / 2) {
						return '#000000';
					}
					else {
						return '#ffffff';
					}
				}
</script>
{% endblock script %} {%block plugins%}
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script
	src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
	integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU="
	crossorigin="anonymous"
></script>
{%endblock plugins%}
